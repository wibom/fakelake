#!/usr/bin/env Rscript
here::i_am("dev/utilities/generate_reference_sampleset.Rscript")
library(here)
library(glue)
options(tidyverse.quiet = TRUE)
library(tidyverse)
source(here("dev/utilities/utilities.R"))

args = commandArgs(trailingOnly = TRUE)
n <- args[1]
abspath_reference <- args[2]

get_sampledates <- function(birth_date, age, interval, seed) {
  #' @bdate: date-vector with birth dates
  #' @age: mean age at sampling
  #' @interval: size of age interval in years (i.e. 40yo +/- 2 years)
  set.seed(seed)
  sample_date <- 
    birth_date + 
    age + 
    runif(length(birth_date), max = interval*365, min = -interval*365)
}
get_heights <- function(sex, seed) {
  set.seed(seed)
  random_heights <- 
    tibble(
      h_f = rnorm(length(sex), mean = 165, sd = 5), # female
      h_m = rnorm(length(sex), mean = 178, sd = 6), # male
      sex = sex,
      height = if_else(sex == "f", h_f, h_m)
    )
  random_heights %>% pull(height)
}
seed <- 42
set.seed(seed)

my_reference <- 
  tibble(
    predict_id = get_predictids(1:n),
    # 1755 +/- 5 years
    birth_date = 
      as.Date("1755-01-01") %>% 
      rep_len(n) +
      floor(stats::runif(n, min = 365.25 * -5, max = 365.25 * 5)),
    # this pattern makes it easier to fake matched case-control studies
    # by simply selecting consecutive rows from this table
    sex = c("m", "m", "f", "f") %>% rep_len(n) 
  ) %>% 
  mutate(
    vip40_date = get_sampledates(birth_date, age = 40, interval = 1, seed),
    vip40_freezethaw = sample(0:1, nrow(.), replace = TRUE),
    
    vip50_date = get_sampledates(birth_date, age = 50, interval = 2, seed),
    vip50_freezethaw = sample(0:2, nrow(.), replace = TRUE),
    
    vip60_date = get_sampledates(birth_date, age = 60, interval = 1, seed),
    vip60_freezethaw = sample(0:1, nrow(.), replace = TRUE),
    
    vip40_weight = rnorm(nrow(.), mean = 70, sd = 7),
    vip50_weight = vip40_weight + stats::runif(nrow(.), min = -2, max = 10),
    vip60_weight = vip50_weight + stats::runif(nrow(.), min = -2, max = 10),
    
    height = get_heights(sex, seed)
  )
dir.create(dirname(abspath_reference), recursive = TRUE, showWarnings = FALSE)
write_tsv(my_reference, file = abspath_reference)

# Add readme:
readme <- glue::glue(
  "
  # Reference
  Reference set with fake individuals and fake VIP-samples to draw from when
  creating mock datasets to the fake lake :).
  
  Reference data are generated by (i) `dev/spinnup_lake.R`, which calls
  (ii) `dev/utilities/generate_reference_sampleset.Rscript`, which creates the
  dataset.
  
  "
)
abspath_reference_readme <- dirname(abspath_reference) %>% here(., "readme.md")
write_file(readme, abspath_reference_readme)


