---
title: "Elasticsearch"
subtitle: "play 1"
date: 
output:
  html_document:
    self_contained: TRUE
    highlight: pygments
toc: TRUE
toc_float: TRUE
toc_depth: 3
code_folding: show
highlight: tango
number_sections: TRUE
theme: paper
keep_md: no
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
here::i_am("es_play/search_play1.Rmd")
library(here)
library(glue)
library(elastic)
library(tidyverse)

# Initialize ----
x <- elastic::connect(
  host = "es01", 
  transport_schema = "https", 
  user = "elastic", 
  pwd = "qqpp11--",
  cainfo = "/usr/share/elasticsearch/config/certs/ca/ca.crt"
)
#x$ping()

# Get indices ----
indices_all <- cat_indices(x, parse = TRUE, verbose = TRUE)$index
```

# Query 1

List all datasets and how they overlap in terms of individuals:

## a) get the filepath of each dataset
```{r}
# get unique values from specific field
# - https://stackoverflow.com/a/57297526/7439717
# - https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html
body <- '{
  "aggs": {
    "files": {
      "terms": { "field": "dataset.filename.keyword" }
    }
  }
}'
res <- Search(x, index = indices_all, body = body, source = FALSE)
filenames <- map_chr(res$aggregations$files$buckets, ~ ..1$key)

print(filenames)
```

## b) get individuals included in each dataset

This **does not** work:
```{r, eval = FALSE}

# -- NOT RUN -- 

# get individuals from a file
get_individuals_in_dataset <- function(filename) {
  browser()
  body <- glue(
    '{{
      "size": 0,
      "query": {{
        "query_string": {{
          "default_field": "dataset.filename",
          "query": "{filename}"
        }}
      }},
      "aggs": {{
        "individuals": {{
          "terms": {{"field": "predict_id.keyword", "size": 500}}
        }}
      }}
    
    }}'
  )
  res <- Search(x, index = indices_all, body = body, source = FALSE)
  individuals <- map_chr(res$aggregations$individuals$buckets, ~ ..1$key)  
}
individuals_per_file <- map(filenames, get_individuals_in_dataset)
```

The above code works for the first file (`"/fakelake/1_bronze/nshds/nshds_mock.tsv"`), but breaks for all the other files.


### Investigate error:

Querying ES from `Kibana > Dev Tools`, gives:

```{r, engine='python', eval=FALSE, python.reticulate=FALSE}
# This returns an error:
GET /_search
{
  "size": 0,
  "query": {
    "query_string": {
      "default_field": "dataset.filename",
      "query": "1_bronze/x2/data_1/mock_UMEA-01-19ML+CDT_EDTA_PLASMA_02FEB1792.XLSX"
    }
  }, 
  "aggs": {
    "individuals": {
      "terms": {"field": "predict_id.keyword", "size": 500}
    }
  }
}

# But this works:
GET /_search
{
  "size": 0,
  "query": {
    "query_string": {
      "default_field": "dataset.filename",
      "query": "x2/data_1/mock_UMEA-01-19ML+CDT_EDTA_PLASMA_02FEB1792.XLSX"
    }
  }, 
  "aggs": {
    "individuals": {
      "terms": {"field": "predict_id.keyword", "size": 500}
    }
  }
}

# Further tests:
# query: "/fakelake/1_bronze/x2/data_1"      -- works
# query: "\/fakelake\/1_bronze\/x2\/data_1*" -- works
# query: "/fakelake/1_bronze/x2/data_1*"     -- works
# query: "/fakelake/1_bronze/x2/data_1/*"    -- error
# query: "1_bronze/x2/data_1/mock_UMEA-01-19ML+CDT_EDTA_PLASMA_02FEB1792.XLSX" -- error

```

Why is this? Here it is suggested it may be solved by different mapping:   https://stackoverflow.com/a/27712853

Retrieve current mapping (from `Kibana/Dev Tools`):
```{r, engine = 'python', eval = FALSE, python.reticulate=FALSE}
GET data_x2--metabolon--dataset/_mapping/field/dataset.filename

# returns:
{
  "data_x2--metabolon--dataset" : {
    "mappings" : {
      "dataset.filename" : {
        "full_name" : "dataset.filename",
        "mapping" : {
          "filename" : {
            "type" : "text",
            "fields" : {
              "keyword" : {
                "type" : "keyword",
                "ignore_above" : 256
              }
            }
          }
        }
      }
    }
  }
}
```

> But, if it's a mapping issue I'd have thought that it would error for all
queries used above... ?


# Query 2
**Get number of samples (not unique) characterized by Metabolon metabolomics**


# Query 3
Get individuals with repeat events (i.e. events at >1 date, not ) in lake.

NOTE:   
"Events" may be defined differently, e.g. "health check" and "questionnaire" 
from the same date may be considered a single event, or multiple events. 

**Here**, I'm only looking at events occurring at more than one date, i.e. I am
considering `event_type = health` and `event_type = questionnaire` as one single
event if they occur on exactly the same date.



# Further thoughts

* Add an index for individuals that tracks consents and 'nej talong'`
<br>
* Are there any benefits of assigning dockument ids? 
    + Each document is currently assigned an `uuid` by ES upon loading indices
<br>
* Currently all mappmings are done dynamically - is there a need to do this more
  carefully (manually)?
<br>
* Perhaps fun to see if I can get SQL-queries to work
    + Using RJDBC: https://dzone.com/articles/analyze-elasticsearch-data-in-r
    + Using Dremeo: https://www.dremio.com/tutorials/joins-in-elasticsearch/


# SessionInfo
```{r}
sessionInfo()
```





