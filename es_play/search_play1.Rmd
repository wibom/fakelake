---
title: "Elasticsearch"
subtitle: "play 1"
date: 
output:
  html_document:
    self_contained: TRUE
toc: TRUE
toc_float: TRUE
toc_depth: 3
code_folding: show
highlight: tango
number_sections: TRUE
theme: paper
keep_md: no
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
here::i_am("es_play/search_play1.Rmd")
library(here)
library(elastic)
library(tidyverse)

# Initialize ----
x <- elastic::connect(
  host = "es01", 
  transport_schema = "https", 
  user = "elastic", 
  pwd = "qqpp11--",
  cainfo = "/usr/share/elasticsearch/config/certs/ca/ca.crt"
)
#x$ping()

# Get indices ----
es_indices <- cat_indices(x, parse = TRUE, verbose = TRUE)$index
```


# Query 1

*Get number of samples (not unique) characterized by Metabolon metabolomics*

```{r}
index_pattern <- "--metabolon--events"
selected_indices <- es_indices[str_detect(es_indices, index_pattern)]

res <- Search(
  x, 
  index = selected_indices, 
  size = "1000",
  
  # using body allows wild-cards in field-names
  # https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-query-string-query.html
  body = '
    {
      "query": {
        "query_string": {
          "query": "metabolon", 
          "default_field": "meta_dir.data.set_*.analyses_platforms"
        }
      }
    }',
  asdf = TRUE
)


res_df <- res$hits$hits %>% as_tibble()
n <- res_df %>% nrow()
n_unique_ind <- n_distinct(res_df$`_source.predict_id`)
```
> There are __`r n`__ samples analyzed by Metabolon metabolomics, donated by
__`r n_unique_ind`__ unique individuals


# Query 2
Get individuals with repeat events (i.e. events at >1 date, not ) in lake.

NOTE: 
"Events" may be defined differently, e.g. "health check" and "questionnaire" 
from the same date may be considered a single event, or multiple events. 

**Here**, I'm only looking at events occurring at more than one date, i.e. I am
considering `event_type = health` and `event_type = questionnaire` as one single
event if they occur on exactly the same date.


```{r}
res <- Search(
  x, 
  index = selected_indices, 
  size = "1000", 
  body = 
    '{
      "_source": [
        "predict_id",
        "date",
        "meta_dir.data.events.event_types",
        "meta_dir.data.id"
      ]
    }', 
  asdf = TRUE
)

# NOTE: 
# Sample from p000000001 @ 1800-01-08 is analyzed in both data0001 and data0002
# They still represent the same sampling event! 
#
# Should this be handled with some kind of event store, where each event is
# assigned a unique, persistent identifier?
# 
# Can this be done on a generic level to handle any kind of event?
#
# For example, an event identifier can be a composite key from:
#  + predict_id
#  + date 
#  + event_type
#  + event_setting (to discriminate between samples donated at both UCAN and VIP
#    on the same date)
#  + sample_type ??? (not sure it should be included; tissue and blood donated
#    simultaneiously - are they separate events?)
#  + ICD10-code (NULL if event != dx)
#  + counter... ?? (are there any events that can not be distinguished by these
#    variables?)
#
# ______________________________________________________________________________
#
# Alternatively, event_ids are assigned within the code of each analyses. This
# allows greater flexibility, useful when the definition of an event may 
# be different from time to time...
# 
# As such:

events_all <- 
  res$hits$hits %>% 
  as_tibble() %>% 
  select(`_index`, starts_with("_source")) %>% 
  rename_all(str_remove, pattern = "_source.") %>% 
  mutate(
    meta_dir.data.events = map_chr(
      meta_dir.data.events, 
      ~ ..1$event_types %>% unlist() %>% str_flatten(collapse = ",")
    )
  ) %>% 
  arrange(predict_id) %>% 
  # minimalistic type of event-identifier suitable in this particular case
  unite("tmp_event_id", predict_id, date, sep = "|", remove = FALSE) %>% 
  relocate(tmp_event_id, predict_id)

# Events from unnknown dates are ignored
events <- 
  events_all %>% 
  filter(!is.na(date))

unique_events <- 
  events %>% 
  group_by(tmp_event_id) %>% 
  summarise(
    event_type = unique(meta_dir.data.events) %>% str_c(collapse = " | "),
    predict_id = unique(predict_id), 
    date = unique(date)
  )
```

__TODO:__ 


* Add `data_types` that are associated with each event... 
* Include `event_setting` in all `--row` indices.


```{r}
unique_events %>% 
  count(predict_id, name = "n.o. events") %>% 
  arrange(desc(`n.o. events`))

```


# Query 3

List all datasets, and how they overlap in terms of (i) individuals, and (ii) 
samples (as defined by `sample_date`).





